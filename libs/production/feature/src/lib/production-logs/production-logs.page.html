<h1>Registros de producci칩n</h1>

<kirby-api-errors [apiError]="errors$ | async"></kirby-api-errors>

<div fxLayout="column"
     fxLayout.gt-xs="row"
     fxLayoutGap="10px"
     fxLayoutGap.gt-xs="20px">
  <a *ngIf="(user$ | async).can('production-logs.create')"
     routerLink="./create"
     mat-stroked-button
     color="primary">
    Crear
  </a>

  <div fxFlex></div>

  <button (click)="exportLogsToCsv()" mat-stroked-button color="primary" matTooltip="Exportar a CSV">
    <mat-icon>download</mat-icon>
  </button>
</div>

<div class="mt-3">
  <form [formGroup]="searchForm" autocomplete="off" (ngSubmit)="submitSearchForm()">
    <div fxLayout="column" fxLayout.gt-xs="row" fxLayoutGap="0px" fxLayoutGap.gt-xs="20px">

      <mat-form-field fxFlex="grow">
        <mat-label>Empleado</mat-label>
        <input [matAutocomplete]="employeeAutocomplete"
               formControlName="employee"
               matInput />
        <mat-autocomplete #employeeAutocomplete="matAutocomplete"
                          [displayWith]="displayNameValue">
          <mat-option *ngFor="let employee of (paginatedEmployees$ | async).data" [value]="employee">
            <span>{{ employee.first_name + ' ' + employee.last_name + ' ' + employee.code }}</span>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field fxFlex="grow">
        <mat-label>Producto</mat-label>
        <input [matAutocomplete]="productAutocomplete"
               formControlName="product"
               matInput />
        <mat-autocomplete #productAutocomplete="matAutocomplete"
                          [displayWith]="displayShortNameValue">
          <mat-option *ngFor="let product of products$ | async" [value]="product">
            <span>{{ product.short_name }}</span>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>

      <mat-form-field fxFlex="grow">
        <mat-label>M치quina</mat-label>
        <input [matAutocomplete]="machineAutocomplete"
               formControlName="machine"
               matInput />
        <mat-autocomplete #machineAutocomplete="matAutocomplete" [displayWith]="displayShortNameValue">
          <mat-option *ngFor="let machine of machines$ | async" [value]="machine">
            <span>{{ machine.short_name }}</span>
          </mat-option>
        </mat-autocomplete>
      </mat-form-field>
    </div>

    <div fxLayout="column" fxLayout.gt-xs="row" fxLayoutGap="0px" fxLayoutGap.gt-xs="20px">
      <mat-form-field fxFlex="grow">
        <mat-label>Peso neto</mat-label>
        <input formControlName="net_weight" matInput type="number" min="0" step=".1" />
      </mat-form-field>

      <mat-form-field fxFlex="grow">
        <mat-label>Fecha de creaci칩n</mat-label>
        <input formControlName="creation_date" matInput type="date" />
      </mat-form-field>
    </div>

    <div class="text-center">
      <button type="submit" mat-stroked-button color="primary">Buscar</button>
    </div>
  </form>
</div>

<div class="my-3 responsive-table shadow">
  <table class="table">
    <thead>
      <tr>
        <th>Producto</th>
        <th>M치quina</th>
        <th>Empleado</th>
        <th>Neto <small>(kg)</small></th>
        <th>Fecha</th>
        <th class="w-5"></th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let log of productionLogs$ | async">
        <td>{{ log.product?.name }}</td>
        <td>{{ log.machine?.short_name }}</td>
        <td>{{ log.employee?.first_name }}</td>
        <td>{{ log.netWeight() }}</td>
        <td>{{ log.created_at | date:'MMM d, h:mm a' }}</td>
        <td>
          <a mat-icon-button [routerLink]="[log.id, 'edit']">
            <mat-icon>edit</mat-icon>
          </a>
        </td>
      </tr>
    </tbody>

  </table>
</div>

<div class="text-right">
  <kirby-pagination [pagination]="pagination$ | async" (paginate)="searchLogs($event)">
  </kirby-pagination>
</div>
